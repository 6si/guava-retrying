<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <title>guava-retrying by rholder</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>guava-retrying</h1>
        <h2>This is a small extension to Google's Guava library to allow for the creation of configurable retrying strategies for an arbitrary function call, such as something that talks to a remote service with flaky uptime.</h2>

        <section id="downloads">
          <a href="https://github.com/rholder/guava-retrying/zipball/master" class="btn">Download as .zip</a>
          <a href="https://github.com/rholder/guava-retrying/tarball/master" class="btn">Download as .tar.gz</a>
          <a href="https://github.com/rholder/guava-retrying" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <p><a href="https://travis-ci.org/rholder/guava-retrying"><img src="https://travis-ci.org/rholder/guava-retrying.png" alt="Build Status"></a></p>

<h2>
<a name="what-is-this" class="anchor" href="#what-is-this"><span class="octicon octicon-link"></span></a>What is this?</h2>

<p>The guava-retrying module provides a general purpose method for retrying arbitrary Java code with specific stop, retry,
and exception handling capabilities that are enhanced by Guava's predicate matching.</p>

<p>This is a fork of the excellent RetryerBuilder code posted <a href="http://code.google.com/p/guava-libraries/issues/detail?id=490">here</a>
by Jean-Baptiste Nizet (JB).  I've added a Gradle build for pushing it up to my little corner of Maven Central so that
others can easily pull it into their existing projects with minimal effort.  It also includes
exponential and Fibonacci backoff <a href="http://rholder.github.io/guava-retrying/javadoc/1.0.5/com/github/rholder/retry/WaitStrategies.html">WaitStrategies</a>
that might be useful for situations where more well-behaved service polling is preferred.</p>

<h2>
<a name="maven" class="anchor" href="#maven"><span class="octicon octicon-link"></span></a>Maven</h2>

<div class="highlight highlight-xml"><pre>    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.github.rholder<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>guava-retrying<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>1.0.5<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
</pre></div>

<h2>
<a name="gradle" class="anchor" href="#gradle"><span class="octicon octicon-link"></span></a>Gradle</h2>

<div class="highlight highlight-groovy"><pre>    <span class="n">compile</span> <span class="s2">"com.github.rholder:guava-retrying:1.0.5"</span>
</pre></div>

<h2>
<a name="quickstart" class="anchor" href="#quickstart"><span class="octicon octicon-link"></span></a>Quickstart</h2>

<p>A minimal sample of some of the functionality would look like:</p>

<div class="highlight highlight-java"><pre><span class="n">Callable</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">callable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// do something useful here</span>
    <span class="o">}</span>
<span class="o">};</span>

<span class="n">Retryer</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">retryer</span> <span class="o">=</span> <span class="n">RetryerBuilder</span><span class="o">.&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">newBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">retryIfResult</span><span class="o">(</span><span class="n">Predicates</span><span class="o">.&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">isNull</span><span class="o">())</span>
        <span class="o">.</span><span class="na">retryIfExceptionOfType</span><span class="o">(</span><span class="n">IOException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">retryIfRuntimeException</span><span class="o">()</span>
        <span class="o">.</span><span class="na">withStopStrategy</span><span class="o">(</span><span class="n">StopStrategies</span><span class="o">.</span><span class="na">stopAfterAttempt</span><span class="o">(</span><span class="mi">3</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">retryer</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="n">callable</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RetryException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>

<p>This will retry whenever the result of the <code>Callable</code> is null, if an <code>IOException</code> is thrown, or if any other
<code>RuntimeException</code> is thrown from the <code>call()</code> method. It will stop after attempting to retry 3 times and throw a
<code>RetryException</code> that contains information about the last failed attempt. If any other <code>Exception</code> pops out of the
<code>call()</code> method it's wrapped and rethrown in an <code>ExecutionException</code>.</p>

<h2>
<a name="exponential-backoff" class="anchor" href="#exponential-backoff"><span class="octicon octicon-link"></span></a>Exponential Backoff</h2>

<p>Create a <code>Retryer</code> that retries forever, waiting after every failed retry in increasing exponential backoff intervals
until at most 5 minutes. After 5 minutes, retry from then on in 5 minute intervals.</p>

<div class="highlight highlight-java"><pre><span class="n">Retryer</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">retryer</span> <span class="o">=</span> <span class="n">RetryerBuilder</span><span class="o">.&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">newBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">retryIfExceptionOfType</span><span class="o">(</span><span class="n">IOException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">retryIfRuntimeException</span><span class="o">()</span>
        <span class="o">.</span><span class="na">withWaitStrategy</span><span class="o">(</span><span class="n">WaitStrategies</span><span class="o">.</span><span class="na">exponentialWait</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="n">MINUTES</span><span class="o">))</span>
        <span class="o">.</span><span class="na">withStopStrategy</span><span class="o">(</span><span class="n">StopStrategies</span><span class="o">.</span><span class="na">neverStop</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>

<p>You can read more about <a href="http://en.wikipedia.org/wiki/Exponential_backoff">exponential backoff</a> and the historic role
it played in the development of TCP/IP in <a href="http://ee.lbl.gov/papers/congavoid.pdf">Congestion Avoidance and Control</a>.</p>

<h2>
<a name="fibonacci-backoff" class="anchor" href="#fibonacci-backoff"><span class="octicon octicon-link"></span></a>Fibonacci Backoff</h2>

<p>Create a <code>Retryer</code> that retries forever, waiting after every failed retry in increasing Fibonacci backoff intervals
until at most 2 minutes. After 2 minutes, retry from then on in 2 minute intervals.</p>

<div class="highlight highlight-java"><pre><span class="n">Retryer</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">retryer</span> <span class="o">=</span> <span class="n">RetryerBuilder</span><span class="o">.&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">newBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">retryIfExceptionOfType</span><span class="o">(</span><span class="n">IOException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">retryIfRuntimeException</span><span class="o">()</span>
        <span class="o">.</span><span class="na">withWaitStrategy</span><span class="o">(</span><span class="n">WaitStrategies</span><span class="o">.</span><span class="na">fibonacciWait</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">MINUTES</span><span class="o">))</span>
        <span class="o">.</span><span class="na">withStopStrategy</span><span class="o">(</span><span class="n">StopStrategies</span><span class="o">.</span><span class="na">neverStop</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>

<p>Similar to the <code>ExponentialWaitStrategy</code>, the <code>FibonacciWaitStrategy</code> follows a pattern of waiting an increasing amount
of time after each failed attempt.</p>

<p>Instead of an exponential function it's (obviously) using a
<a href="https://en.wikipedia.org/wiki/Fibonacci_numbers">Fibonacci sequence</a> to calculate the wait time.</p>

<p>Depending on the problem at hand, the <code>FibonacciWaitStrategy</code> might perform better and lead to better throughput than
the <code>ExponentialWaitStrategy</code> - at least according to
<a href="http://www.comp.leeds.ac.uk/ukpew09/papers/12.pdf">A Performance Comparison of Different Backoff Algorithms under Different Rebroadcast Probabilities for MANETs</a>.</p>

<p>The implementation of <code>FibonacciWaitStrategy</code> is using an iterative version of the Fibonacci because a (naive) recursive
version will lead to a <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/StackOverflowError.html">StackOverflowError</a>
at a certain point (although very unlikely with useful parameters for retrying).</p>

<p>Inspiration for this implementation came from <a href="https://paperairoplane.net/?p=640">Efficient retry/backoff mechanisms</a>.</p>

<h2>
<a name="documentation" class="anchor" href="#documentation"><span class="octicon octicon-link"></span></a>Documentation</h2>

<p>Javadoc can be found <a href="http://rholder.github.io/guava-retrying/javadoc/1.0.5">here</a>.</p>

<h2>
<a name="building-from-source" class="anchor" href="#building-from-source"><span class="octicon octicon-link"></span></a>Building from source</h2>

<p>The guava-retrying module uses a <a href="http://gradle.org">Gradle</a>-based build system. In the instructions
below, <a href="http://vimeo.com/34436402"><code>./gradlew</code></a> is invoked from the root of the source tree and serves as
a cross-platform, self-contained bootstrap mechanism for the build. The only
prerequisites are <a href="https://help.github.com/articles/set-up-git">Git</a> and JDK 1.6+.</p>

<h3>
<a name="check-out-sources" class="anchor" href="#check-out-sources"><span class="octicon octicon-link"></span></a>check out sources</h3>

<p><code>git clone git://github.com/rholder/guava-retrying.git</code></p>

<h3>
<a name="compile-and-test-build-all-jars" class="anchor" href="#compile-and-test-build-all-jars"><span class="octicon octicon-link"></span></a>compile and test, build all jars</h3>

<p><code>./gradlew build</code></p>

<h3>
<a name="install-all-jars-into-your-local-maven-cache" class="anchor" href="#install-all-jars-into-your-local-maven-cache"><span class="octicon octicon-link"></span></a>install all jars into your local Maven cache</h3>

<p><code>./gradlew install</code></p>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>The guava-retrying module is released under version 2.0 of the
<a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License</a>.</p>

<h2>
<a name="contributors" class="anchor" href="#contributors"><span class="octicon octicon-link"></span></a>Contributors</h2>

<ul>
<li>Jean-Baptiste Nizet (JB)</li>
<li>Jason Dunkelberger (dirkraft)</li>
<li>Diwaker Gupta (diwakergupta)</li>
<li>Jochen Schalanda (joschi)</li>
</ul>
      </section>
    </div>

    
  </body>
</html>